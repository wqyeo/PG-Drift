name: Run and send results to AWS S3

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    environment: AWS
    permissions:
      id-token: write   # required for OIDC
      contents: read    # required for actions/checkout

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9.23"

      - name: Install dependencies
        working-directory: src
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute Script
        working-directory: src
        env:
          DB_COUNT: ${{ vars.DB_COUNT }}
          PG_DRIFT_DB_HOST_1: ${{ secrets.PG_DRIFT_DB_HOST_1 }}
          PG_DRIFT_DB_PORT_1: ${{ secrets.PG_DRIFT_DB_PORT_1 }}
          PG_DRIFT_DB_USER_1: ${{ secrets.PG_DRIFT_DB_USER_1 }}
          PG_DRIFT_DB_PASSWORD_1: ${{ secrets.PG_DRIFT_DB_PASSWORD_1 }}
          PG_DRIFT_DB_NAME_1: ${{ vars.PG_DRIFT_DB_NAME_1 }}
          PG_DRIFT_DB_HOST_2: ${{ secrets.PG_DRIFT_DB_HOST_2 }}
          PG_DRIFT_DB_PORT_2: ${{ secrets.PG_DRIFT_DB_PORT_2 }}
          PG_DRIFT_DB_USER_2: ${{ secrets.PG_DRIFT_DB_USER_2 }}
          PG_DRIFT_DB_PASSWORD_2: ${{ secrets.PG_DRIFT_DB_PASSWORD_2 }}
          PG_DRIFT_DB_NAME_2: ${{ vars.PG_DRIFT_DB_NAME_2 }}
          PG_DRIFT_TARGET_FOLDER: ${{ secrets.PG_DRIFT_TARGET_FOLDER }}
        run: python main.py
        
      - name: Configure AWS OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_ROLE_NAME }}
          aws-region: ap-southeast-1

      - name: Compute upload timestamp
        id: ts
        run: echo "value=$(date +'%d-%m-%Y-%H%M%S')" >> "$GITHUB_OUTPUT"

      - name: Upload output folder to S3 (timestamped)
        working-directory: src
        env:
          S3_BUCKET_URI: ${{ vars.S3_BUCKET_URI }}
          PG_DRIFT_TARGET_FOLDER: ${{ vars.PG_DRIFT_TARGET_FOLDER }}
          TS: ${{ steps.ts.outputs.value }}
        run: |
          if [ -z "$PG_DRIFT_TARGET_FOLDER" ]; then
            echo "PG_DRIFT_TARGET_FOLDER is not set"
            exit 1
          fi

          LOCAL_PATH="./$PG_DRIFT_TARGET_FOLDER"
          if [ ! -d "$LOCAL_PATH" ]; then
            echo "Local folder does not exist: $LOCAL_PATH"
            ls -la
            exit 1
          fi

          DEST="${S3_BUCKET_URI%/}/$TS/"
          echo "Uploading $LOCAL_PATH -> $DEST"
          aws s3 cp "$LOCAL_PATH" "$DEST" --recursive
